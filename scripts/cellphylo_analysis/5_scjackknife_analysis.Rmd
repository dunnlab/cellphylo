---
title: "single cell jackknife analysis"
---

This notebook provides the workflow to calculate the single cell jackknife (scjackknife) scores for Figure 4.

#Preliminaries
```{r}
setwd("~/repo/cellphylo/scripts/cellphylo_analysis/")

```

# Create scjackknife files
We subsample 1 cell per cell type group from the 540 cell 2000 gene matrix (see `2_Create_Matrices.Rmd`). Create 500 samples.

500 samples
```{r}



```


# Infer a tree from each scjackknife matrix

The `contml` settings:
  C: continuous characters
  J:   Randomize input order of species (jumble)
    Random number to seed (see bash script)
    Number of times to jumble: 100
  G: Global rearrangements

#

### Create scjack parallel scripts
Iteratively make 1-50 and 51-100 scjack scripts from a template input script.

Template input script: in_script_scjack_parallel_540.sh
```
#!/bin/bash

#run contml on infile_n
#must not have an 'infile' indirectory - will replace with infile_n
#must have an (empty) outfile and outtree so can set

n=ITERATION_INDEX

cd /contml

echo "Run: ${n}"

#create random seed for jumble
RAND_NUM=$(shuf -i 1-2000000000 -n 1)
random_seed=$(($RAND_NUM * 2 + 1))
echo "seed: ${random_seed}"

outfile_new="outfile_scjack_jumble_search_540_${n}_${random_seed}"
outtree_new="outtree_scjack_jumble_search_540_${n}_${random_seed}"
infile="./scjack_540_infiles/infile_scjackknife_540_final_${n}"

echo "outfile: ${outfile_new}"
echo "outtree: ${outtree_new}"
echo "infile: ${infile}"

printf "${infile}\nF\n${outfile_new}\nC\nJ\n${random_seed}\n100\nG\nY\nF\n${outtree_new}\n"| ./phylip/phylip-3.697/exe/contml
#test
#printf "${infile}\nF\n${outfile_new}\nC\nJ\n${random_seed}\n2\nG\nY\nF\n${outtree_new}\n"| ./phylip/phylip-3.697/exe/contml

mv ${outtree_new} ./outtrees_scjack_jumble_search_540/${outtree_new}.tre
mv ${outfile_new} ./outfiles_scjack_jumble_search_540/${outfile_new}.txt


echo "Run ${n} complete"
```

Script to iteratively make repicate scripts from template: make_reps_scjack_parallel_540.sh
```
#!/bin/bash

### Modified from script produced by ChatGPT Dec 9 2022.
### Prompt: "Write a bash script that iteratively reads in a text file, copies and renames it a new iterative file name, and replaces a string in the file with the iteration index. Make it do it 100 times."

# Set the starting iteration index
index=1

# Set the filename of the original file
filename="in_script_scjack_parallel_540.sh"

# Set the string to be replaced in the file
replace="ITERATION_INDEX"

# Set the prefix for the new iterative filenames
new_filename_prefix="script_scjack_jumble_search_540_"

# Set the suffix for the new iterative filenames
new_filename_suffix=".sh"

# Set the maximum number of iterations
max_iterations=500


# Iterate until the original file does not exist or the maximum number of iterations is reached
while [ -f $filename ] && [ $index -le $max_iterations ]
do
  # Copy and rename the file with the current iteration index
  #don't need to do this
  #cp $filename $new_filename_prefix$index$new_filename_suffix

  # Replace the string in the copied file with the iteration index
  #sed -i "s/$replace/$index/g" $new_filename_prefix$index$new_filename_suffix
  #sed command did not work. Remove -i flag, input old file, pipe sed output to new file.
  sed "s/$replace/$index/g" $filename > $new_filename_prefix$index$new_filename_suffix
  
  #set permissions
  chmod u+x $new_filename_prefix$index$new_filename_suffix
  
  # Increment the iteration index
  index=$((index+1))
  
done

```
input:
MD5 (in_script_scjack_parallel_540.sh) = 17a61e4a29de1f26383609f67caef08a
MD5 (make_reps_scjack_parallel_540.sh) = febefdffb7aafb13ffb94466eca502c6

output:
MD5 (scjack_540_parallel_scripts.tar.gz) = 5499ba69fd577a6806a329cd7c0ebcc0

Script for running scjack parallel: do preliminaries (making dirs etc) and run all scjack scripts in parallel: run_scjack_parallel_540.sh

```
#!/bin/bash

#run Jumble in parallel
#only want to set up directories once
#need 1 empty outfile and outtree so you can indicate indiividual names for output files

cd /contml

mkdir outtrees_scjack_jumble_search_540
mkdir outfiles_scjack_jumble_search_540

#make an empty outfile and outtree so contml prompts for custom file names
touch outfile
touch outtree

#ensure that there is no 'infile'. Will throw up error if already no infile.
#rm infile

echo "scjack jumble search preliminaries complete"

#send in the command. Remove last `&`. #chatgpt

#for i in {1..50}; do printf "./script_scjack_jumble_search_540_$i.sh & %.0s"; done

#run the script 50 times in parallel
./script_scjack_jumble_search_540_1.sh & ./script_scjack_jumble_search_540_2.sh & ./script_scjack_jumble_search_540_3.sh & ./script_scjack_jumble_search_540_4.sh & ./script_scjack_jumble_search_540_5.sh & ./script_scjack_jumble_search_540_6.sh & ./script_scjack_jumble_search_540_7.sh & ./script_scjack_jumble_search_540_8.sh & ./script_scjack_jumble_search_540_9.sh & ./script_scjack_jumble_search_540_10.sh & ./script_scjack_jumble_search_540_11.sh & ./script_scjack_jumble_search_540_12.sh & ./script_scjack_jumble_search_540_13.sh & ./script_scjack_jumble_search_540_14.sh & ./script_scjack_jumble_search_540_15.sh & ./script_scjack_jumble_search_540_16.sh & ./script_scjack_jumble_search_540_17.sh & ./script_scjack_jumble_search_540_18.sh & ./script_scjack_jumble_search_540_19.sh & ./script_scjack_jumble_search_540_20.sh & ./script_scjack_jumble_search_540_21.sh & ./script_scjack_jumble_search_540_22.sh & ./script_scjack_jumble_search_540_23.sh & ./script_scjack_jumble_search_540_24.sh & ./script_scjack_jumble_search_540_25.sh & ./script_scjack_jumble_search_540_26.sh & ./script_scjack_jumble_search_540_27.sh & ./script_scjack_jumble_search_540_28.sh & ./script_scjack_jumble_search_540_29.sh & ./script_scjack_jumble_search_540_30.sh & ./script_scjack_jumble_search_540_31.sh & ./script_scjack_jumble_search_540_32.sh & ./script_scjack_jumble_search_540_33.sh & ./script_scjack_jumble_search_540_34.sh & ./script_scjack_jumble_search_540_35.sh & ./script_scjack_jumble_search_540_36.sh & ./script_scjack_jumble_search_540_37.sh & ./script_scjack_jumble_search_540_38.sh & ./script_scjack_jumble_search_540_39.sh & ./script_scjack_jumble_search_540_40.sh & ./script_scjack_jumble_search_540_41.sh & ./script_scjack_jumble_search_540_42.sh & ./script_scjack_jumble_search_540_43.sh & ./script_scjack_jumble_search_540_44.sh & ./script_scjack_jumble_search_540_45.sh & ./script_scjack_jumble_search_540_46.sh & ./script_scjack_jumble_search_540_47.sh & ./script_scjack_jumble_search_540_48.sh & ./script_scjack_jumble_search_540_49.sh & ./script_scjack_jumble_search_540_50.sh

echo "Commands 1-50 complete"

#etc until Commands 451-500 complete

echo "ALL COMMANDS COMPLETE"

exit

```
MD5 (run_scjack_parallel_540.sh) = 0184bb194ed07fcd0a1a94f3e2de4165



### Run Scjack parallel scripts:
Run:
```
#new tmux session
tmux new -s scjack_jumble_search_1

sudo service docker start
sudo docker run --rm --name contml -v /home/ec2-user/contml:/contml -it dunnlab/ubuntu-dev:20.04 /bin/bash 

./run_scjack_parallel_540.sh | tee -a "run_scjack_parallel_540.log"


```
input: 
MD5 (scjack_540_parallel_scripts.tar.gz) = 5499ba69fd577a6806a329cd7c0ebcc0
MD5 (run_scjack_parallel_540.sh) = 0184bb194ed07fcd0a1a94f3e2de4165
MD5 (scjack_540_infiles.tar.gz) = d7ba89a566941ea12b868ac8e532ea28

output:
MD5 (output_scjack_jumble_search_540.tar.gz) = a68946b9a0a48742be977442e9145a0c

Remove errored out files
```
find . -type f -print| xargs grep "Ln Likelihood"| cut -d ":" -f 1| xargs -I '{}' cp '{}' ../outfiles_scjack_jumble_search_540_processed
```
Delete any empty tree files
```
find ./ -size 0 -print -delete
```
input:
MD5 (output_scjack_jumble_search_540.tar.gz) = a68946b9a0a48742be977442e9145a0c

output:
MD5 (output_scjack_jumble_search_540_processed.tar.gz) = a7840d3b02c1d1e8aa8174c4a14dbba6


Because I removed files, index between output files and matrices directory do not match.
### run:
```{r}
setwd("~/repo/aqhumor/AqHum_5Species")

#unrpocessed outtrees dir
outtrees_dir <- "aqhumor_final/scjackknife/scjack_54_jumble_search/output_scjack_jumble_search_540/outtrees_scjack_jumble_search_540/"

id_errored_runs(outtrees_dir)
```

Then in bash:
```
cd scjack_540_matrices
rm -r $(<errored_runs.txt)

```
input:
MD5 (scjack_540_matrices.tar.gz) = fec67e7d7afa0621617823635dd17eeb
output:
MD5 (scjack_540_matrices_processed.tar.gz) = b1280a4dfba74de7234d45f383c212db

### Score scjack 54
Label scjackknife trees
```{r}
setwd("~/repo/aqhumor/AqHum_5species/")

#convert tree labels to common names
n_trees = c(1:464)
matrix_dir_path = "aqhumor_final/scjackknife/scjack_54_jumble_search/processed/scjack_540_matrices_processed/"
tree_dir_path = "aqhumor_final/scjackknife/scjack_54_jumble_search/processed/output_scjack_jumble_search_540_processed/outtrees_scjack_jumble_search_540_processed/"

labelled_trees <- label_scjack_trees_54(n_trees=n_trees, matrix_dir_path = matrix_dir_path, tree_dir_path = tree_dir_path)
```

Identify and score best scjack tree - FBP
```{r}

setwd("~/repo/aqhumor/AqHum_5species/")

tree_dir_path = "aqhumor_final/scjackknife/scjack_54_jumble_search/processed/scjack_540_trees_common_label"

#find best tree
best_scjack_tree(tree_dir_path = tree_dir_path)
list.files(tree_dir_path)

#score
scjack_multiphylo <- combine_multi_trees(tree_dir_path)
#best mean
focal_tree_path = "aqhumor_final/scjackknife/scjack_54_jumble_search/processed/scjack_540_trees_common_label/scjackknife_540_outtrees_common_labels_116_2192404113.tre"
#best median
focal_tree_path = "aqhumor_final/scjackknife/scjack_54_jumble_search/processed/scjack_540_trees_common_label/scjackknife_540_outtrees_common_labels_404_2139113093.tre"

tree <- score_scjack(scjack_multiphylo = scjack_multiphylo,focal_tree_path = focal_tree_path, print=TRUE)
```

Plot scjack scores on best 54 jumble search tree
```{r}
#try the best jumble search tree
#add common labels 
n_trees = 1
matrix_dir_path = "aqhumor_final/scjackknife/scjack_54_jumble_search/best_trees/best_jumble_tree/matrix/"
tree_dir_path2 = "aqhumor_final/scjackknife/scjack_54_jumble_search/best_trees/best_jumble_tree/tree/"
label_scjack_trees_54(n_trees=n_trees, matrix_dir_path = matrix_dir_path, tree_dir_path = tree_dir_path2)

#manually add the best jumble tree to tree dir (did not save in dir)
#scjackknife_540_outtrees_common_labels_search_61674183.tre to scjack_540_trees_common_label_with_best_jumble

#score best jumble tree
tree_dir_path = "aqhumor_final/scjackknife/scjack_54_jumble_search/processed/scjack_540_trees_common_label_with_best_jumble"
focal_tree_path = "aqhumor_final/scjackknife/scjack_54_jumble_search/best_trees/best_jumble_tree/scjackknife_540_outtrees_common_labels_search_61674183.tre"
scjack_multiphylo <- combine_multi_trees(tree_dir_path)
tree <- score_scjack(scjack_multiphylo = scjack_multiphylo,focal_tree_path = focal_tree_path, print=TRUE)

``` 

#TBP - 540 scjack
New two newick files: ref and boot
Boot is multi-tree file, 1 tree per line:
```{r boot_files}
library(ape)

multi_trees <- combine_multi_trees("aqhumor_final/scjackknife/scjack_54_jumble_search_TBP/scjack_540_trees_common_label/")


write.tree(multi_trees, file="multi_trees_scjack_54_jumble_search_common_label.tre")

#wrangle best tree for use with scjack

```

input:
MD5 (scjack_540_trees_common_label.tar.gz) = 3a8ba29e2939268f9eeaf1a950cb62d2

output:
MD5 (multi_trees_scjack_54_jumble_search_common_label.tre) = 7e57a6d6e15e67d781c4b001304e37d0


Wrangle best jumble tree
```{r boot_files2}
tree <- read.tree("aqhumor_final/scjackknife/scjack_54_jumble_search_TBP/outtree_54_jumble_search_1249177875.tre")

labelled_tree <- label_tree(matrix_path = "aqhumor_final/jumble/54_jumble_search/contml_54cell_subset_pca_var_norm_20PC_mtx/", tree_path = "aqhumor_final/scjackknife/scjack_54_jumble_search_TBP/outtree_54_jumble_search_1249177875.tre", file_name = "outtree_54_jumble_search_1249177875_label.tre", print=TRUE)

#make common labels - code stolen from scjack label
  species <- sapply(strsplit(labelled_tree$tip.label, "_"), function(v){return(v[1])})
  cluster_id <- sapply(strsplit(labelled_tree$tip.label, "_"), function(v){return(v[3])})
  new_label <- paste0(species, "_", cluster_id)
  common_labels_tree <- labelled_tree
  common_labels_tree$tip.label <- new_label
  #print out common labels tree
    write.tree(common_labels_tree, file="outtree_54_jumble_search_1249177875_common_label.tre")

```

>>> OR <<<
***Use label_scjack_trees_54*** function instead:
Made directories:
wrangle_best_tree
  matrix_dir -> contml_54cell_subset_pca_var_norm_20PC_mtx
  tree_dir -> outtree_54_jumble_search_1249177875.tre
Because label_scjack_trees_54 requires the matrix or tree be in directories (since it expects more than one run)

```{r}
library(ape)

tree <- "aqhumor_final/scjackknife/scjack_54_jumble_search_TBE/wrangle_best_tree/tree_dir/"
#matrix must be in its own directory
matrix_dir_path <- "aqhumor_final/scjackknife/scjack_54_jumble_search_TBE/wrangle_best_tree/matrix_dir/"

label_scjack_trees_54(n_trees = 1, matrix_dir_path = matrix_dir_path, tree_dir_path = tree )

```

Run booster
github: https://github.com/evolbioinfo/booster (accessed Apr 10 2023)
releases: https://github.com/evolbioinfo/booster/releases
v0.1.2 booster_macos64
MD5 (booster_macos64) = 1a753d2de972cf91f0f11103b6894d5e

```
./booster_macos64 -a tbe -i run/outtree_54_jumble_search_1249177875_common_label.tre -b run/multi_trees_scjack_54_jumble_search_common_label.tre > outtree_54_jumble_search_1249177875_tbe_score.tre

```
input:
MD5 (multi_trees_scjack_54_jumble_search_common_label.tre) = 7e57a6d6e15e67d781c4b001304e37d0
MD5 (outtree_54_jumble_search_1249177875_common_label.tre) = 6c1581caf20a6e3fee821c8a09799710

output:
MD5 (outtree_54_jumble_search_1249177875_tbe_score.tre) = ac72f71a46ef35cf4df8cb06183d10bc
