---
title: "Create_matrix"
output: html_document
date: "2023-04-22"
---

This notebook walks you through steps 1-7 (Fig. S1) of the cellphylo workflow created for Mah & Dunn 2023. 

#Preliminaries
```{r setup}
#set working directories
setwd("~/repo/cellphylo/scripts/cellphylo_analysis/")

#load libraries

```

Create some directories
```{r}

# for meta data annotation files
dir.create("./ann")
# for the  matrices created during cellphylo analysis
dir.create("./matrix/raw")
dir.create("./matrix/raw_csv")
dir.create("./matrix/10x")

```

## Wrangle data
We use the single cell atlas from [van Zyl et al. (2020)](https://doi.org/10.1073/pnas.2001250117) as our pilot data.

Download the meta data file provided by van Zyl et al. (2020): [all_five_species_metafile.csv](https://singlecell.broadinstitute.org/single_cell/study/SCP780/).
This meta data file has information on sample ID, cell barcode and cluster ID (which corresponds to "cell type groups" in Mah & Dunn 2023).
Deposit the meta data file in the `./ann` directory.

### Wrangle the meta data file. 
```{r wrangle-metadata}

wrangled_meta <- wrangle_metadata(path_to_meta_file="./ann/all_five_species_metafile.csv")

```

This creates and deposites `all_five_species_metafile_wrangled.csv` in the `ann` directory. This file has parsed out the cell identifier (used by van Zyl as the cell names in the UMI matriecs), cluster_id, sample_id and cell_barcode.

### Wrangle UMI matries
Download the raw UMi matrices from NCBI GEO database (GSE146188).

[human](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE148371)
[macF (Macaca fascicularis)](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE148373)
[macM (Macaca mulatta)](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE148374)
[mouse](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE146186)
[pig](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE146187)

Deposit these gzipped files in `matrix/raw_csv`.

#### Convert csv files to 10x-style sparse matrices

Convert the CSV files to 10x-style feature-barcode matrices. Sparse matrix format is easier to work with.
```{r convert-to-10x}

#mouse
convert_to_10x(path_to_csv = "matrix/raw_csv/GSE146186_Mouse_count_matrix.csv.gz" , dir_name = "aqhumor_UMI_mouse")
#pig
convert_to_10x(path_to_csv = "matrix/raw_csv/GSE146187_Pig_count_matrix.csv.gz" , dir_name = "aqhumor_UMI_pig")
#human
convert_to_10x(path_to_csv = "matrix/raw_csv/GSE148371_Human_count_matrix.csv.gz" , dir_name = "aqhumor_UMI_human")
#macF
convert_to_10x(path_to_csv = "matrix/raw_csv/GSE148373_MacaF_count_matrix.csv.gz" , dir_name = "aqhumor_UMI_macF")
#macM 
convert_to_10x(path_to_csv = "matrix/raw_csv/GSE148374_MacaqueM_count_matrix.csv.gz" , dir_name = "aqhumor_UMI_macM")

```
Matrices are deposited in `matrix/10x/`.

#### Convert cell identifiers to cellphylo format

Cell identifiers in the raw matrix are currently:
<sample_id>_<cell_barcode>.

Convert cell identifiers to `cellphylo` format.
The cellphylo format is:

<species>_<sample_id>_<cluster_id>_<cell_type_id>_<cell_barcode>

- species: species name
- sample id: the id of the sequencing batch sample
- cluster id: aka 'cell type group' - the cluster id assigned by van Zyl et al. (2020). This consists of a cluster number (where present) and the cell type label.
- cell_type_id: the cell type label.

This format is crucial as this information will be parsed repeatedly during cellphylo analysis from the cell names.

```{r wrangle-matrix-names}

#convert cell identifiers to cellphylo format and create a new matrix with this new format
metadata_file = "ann/all_five_species_metafile_wrangled.csv" 

#mouse
wrangled_mat <- wrangle_matrix(path_to_mat = "matrix/10x/aqhumor_UMI_mouse", metadata_file = metadata_file, species = "mouse")
#pig
wrangled_mat <- wrangle_matrix(path_to_mat = "matrix/10x/aqhumor_UMI_pig", metadata_file = metadata_file, species = "pig")
#human
wrangled_mat <- wrangle_matrix(path_to_mat = "matrix/10x/aqhumor_UMI_human", metadata_file = metadata_file, species = "human")
#macF
wrangled_mat <- wrangle_matrix(path_to_mat = "matrix/10x/aqhumor_UMI_macF", metadata_file = metadata_file, species = "macF")
#macM
wrangled_mat <- wrangle_matrix(path_to_mat = "matrix/10x/aqhumor_UMI_macM", metadata_file = metadata_file, species = "macM")

#check that cell ids are in cell phylo format
colnames(wrangled_mat)

```

#Within-species integration
Fig. S1, steps x-x
