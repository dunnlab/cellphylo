---
title: "Fig 3 - tree comparison"
output: html_notebook
---

# Supplementary trees
## pc sweep example trees
3, 20, 50, 100, 919

Make a 919 cell 919 PC tree and a 919 cell 500 PC tree
infile:
```{r}
library(Seurat)
library(DropletUtils)
library(tidyverse)

setwd("~/repo/aqhumor/AqHum_5Species/")

matrix_path = "aqhumor_final/matrix_final/integrated/cross_species/cross_species_integrated/aqhumor_cross_species_integrated_mtx/"

#unfiltered raw data
mat <- Read10X(matrix_path)
mat <- as.matrix(mat) %>% t()

#pca
pc <- prcomp(mat, center=TRUE, scale=FALSE)
x <- pc$x
#normalize sd
sds <- apply(x,2,sd)
x.scaled <- t(t(x)/sds)
apply(x.scaled, 2, sd)

#919 PC
#x.sweep.matrix <- x.scaled[,1:919] %>% as.matrix()
#500 PC
x.sweep.matrix <- x.scaled[,1:500] %>% as.matrix()

#format to phylip
phylip <- make_infile(matrix = x.sweep.matrix, print=FALSE)
#write table
#919 PC
#write.table(phylip, file="infile_pca_var_norm_pc_sweep_919", quote=FALSE, sep=" ",   row.names=FALSE, col.names=FALSE, na= "")
#500 PC
write.table(phylip, file="infile_pca_var_norm_pc_sweep_500", quote=FALSE, sep=" ",   row.names=FALSE, col.names=FALSE, na= "")

```
input: 
aqhumor_cross_species_integrated_mtx mtx: daa2aef295e2b7f07f80de669b8a3c1c

output: 
infile_pca_var_norm_pc_sweep_919 = 874470766bbf29cde36b7fd2861e951e
infile_pca_var_norm_pc_sweep_500 = 954c492c44877f589c1adf5667e03bab

AWS:
AWS Linux, t20 micro, 8 gib gp2
set up instance following details under #pc sweep bash script

run contml:
```printf "C\nY\n"| ./phylip/phylip-3.697/exe/contml | tee -a "pc_sweep_919_tree.log"```

919 t2.2xlarge (15 gib), c5.9xlarge (32vCPU, 72 GiB, 30 gib storage)
500 t2 micro

input:
infile_pca_var_norm_pc_sweep_919 = 874470766bbf29cde36b7fd2861e951e
infile_pca_var_norm_pc_sweep_500 = 954c492c44877f589c1adf5667e03bab

output:
outfile_919_PC_sweep_919_final = 79704ba160d084e30ff3d05687f9cab7
outtree_919_PC_sweep_919_final.tre = 2c685ce8f43fd0cbb6724d096b17c2f7
outfile_500_PC_sweep_919_final = 31069f74c0b883f9d531e4255677dd9a
outtree_500_PC_sweep_919_final.tre = b76b23f7c3a0b506071422bb42af6b83

```{r}
library(ape)
library(Seurat)
library(DropletUtils)

setwd("~/repo/aqhumor/AqHum_5Species/")

pc3 <- "aqhumor_final/pc_sweep/pc_sweep_919_out/pc_sweep_919_outtrees/outtree_3_PC_sweep_919_final.tre"
pc20 <- "aqhumor_final/pc_sweep/pc_sweep_919_out/pc_sweep_919_outtrees/outtree_20_PC_sweep_919_final.tre"
pc50 <- "aqhumor_final/pc_sweep/pc_sweep_919_out/pc_sweep_919_outtrees/outtree_50_PC_sweep_919_final.tre"
pc100 <- "aqhumor_final/pc_sweep/pc_sweep_919_out/pc_sweep_919_outtrees/outtree_100_PC_sweep_919_final.tre"
pc500 <- "aqhumor_final/plots_final/supplemental_trees/pc_sweep_tree_examples/500PC/outtree_500_PC_sweep_919_final.tre"
pc919 <- "aqhumor_final/plots_final/supplemental_trees/pc_sweep_tree_examples/919PC/outtree_919_PC_sweep_919_final.tre"

#matrix must be transposed so cell names = row ids for lable_tree() to work
orig_matrix <- Read10X("aqhumor_final/matrix_final/integrated/cross_species/cross_species_integrated/aqhumor_cross_species_integrated_mtx/")
transpose_matrix <- t(as.matrix(orig_matrix)) %>% as.sparse()
write10xCounts(path="aqhumor_cross_species_integrated_mtx_trans", x=transpose_matrix, version="3")

matrix_path = "aqhumor_final/plots_final/supplemental_trees/pc_sweep_tree_examples/aqhumor_cross_species_integrated_mtx_trans/"
pc3_label <- label_tree(matrix_path = matrix_path, tree_path = pc3, file_name = "outtree_3_PC_sweep_919_final_label.tre", print=TRUE)
pc20_label <- label_tree(matrix_path = matrix_path, tree_path = pc20, file_name = "outtree_20_PC_sweep_919_final_label.tre", print=TRUE)
pc50_label <- label_tree(matrix_path = matrix_path, tree_path = pc50, file_name = "outtree_50_PC_sweep_919_final_label.tre", print=TRUE)
pc100_label <- label_tree(matrix_path = matrix_path, tree_path = pc100, file_name = "outtree_100_PC_sweep_919_final_label.tre", print=TRUE)
pc500_label <- label_tree(matrix_path = matrix_path, tree_path = pc500, file_name = "outtree_500_PC_sweep_919_final_label.tre", print=TRUE)
pc919_label <- label_tree(matrix_path = matrix_path, tree_path = pc919, file_name = "outtree_919_PC_sweep_919_final_label.tre", print=TRUE)
```

Color tree to see degree of monophyly grouping
```{r}
library(ape)
library(phytools)

setwd("~/repo/aqhumor/AqHum_5Species/")

pc3 <- "aqhumor_final/plots_final/supplemental_trees/pc_sweep_tree_examples/outtree_3_PC_sweep_919_final_label.tre"
pc20 <- "aqhumor_final/plots_final/supplemental_trees/pc_sweep_tree_examples/outtree_20_PC_sweep_919_final_label.tre"
pc50 <- "aqhumor_final/plots_final/supplemental_trees/pc_sweep_tree_examples/outtree_50_PC_sweep_919_final_label.tre"
pc100 <- "aqhumor_final/plots_final/supplemental_trees/pc_sweep_tree_examples/outtree_100_PC_sweep_919_final_label.tre"
pc500 <- "aqhumor_final/plots_final/supplemental_trees/pc_sweep_tree_examples/outtree_500_PC_sweep_919_final_label.tre"
pc919 <- "aqhumor_final/plots_final/supplemental_trees/pc_sweep_tree_examples/outtree_919_PC_sweep_919_final_label.tre"

#order branches
#load trees
tree20 <- read.tree(pc20)
tree500 <- read.tree(pc500)
tree919 <- read.tree(pc919)
#phytools
cophylo <- cophylo(tree20, tree500)

#use labelled 54 cell scjackknife trees for examples




print=TRUE

tree_path <- pc3
tree.plots <- color_tree(tree_path,print)

tree_path <- pc20
tree.plots <- color_tree(tree_path,print)

tree_path <- pc50
tree.plots <- color_tree(tree_path,print)

tree_path <- pc100
tree.plots <- color_tree(tree_path,print)

tree_path <- pc500
tree.plots <- color_tree(tree_path,print)

tree_path <- pc919
tree.plots <- color_tree(tree_path,print)

```