---
title: "Figure 5: phenotype similarity tree"
output: html_notebook
---

This code was used to create Fig. 5, the phenotype similarity tree.

Calcualte a neighbour-joining tree from the 54 cell 20 PC matrix:

## nj tree of 54 cell matrix
```{r}
library(Seurat)
library(ape)
library(phangorn)

setwd("~/repo/aqhumor/AqHum_5Species/")

#read in matrix
mat <- Read10X("aqhumor_final/jumble/54_jumble_search/contml_54cell_subset_pca_var_norm_20PC_mtx/")

#make nj tree
dist <- dist(mat, method="euclidean")
nj.tree <- nj(dist)

write.nexus(nj.tree, file=paste0("54_pca_var_norm_20_PC_nj.tre"), translate=FALSE)

```

## Fig. 5: nj tree of 54 cell matrix
```{r}
library(Seurat)
library(ape)
library(phangorn)

setwd("~/repo/aqhumor/AqHum_5Species/")

#read in matrix
mat <- Read10X("aqhumor_final/jumble/54_jumble_search/contml_54cell_subset_pca_var_norm_20PC_mtx/")

#make nj tree
dist <- dist(mat, method="euclidean")
nj.tree <- nj(dist)

write.nexus(nj.tree, file=paste0("54_pca_var_norm_20_PC_nj.tre"), translate=FALSE)

```

differences in topology vs 54 cell phylo (Fig. 4)
human CM and macM 17CM are switched 
pericyte
schwann cell -my
schlemm's canal
macrophage
-clades within cell phylo much more nested, nj tree comes out with more balanced clumps

input:
MD5 (contml_54cell_subset_pca_var_norm_20PC_mtx/matrix.mtx.gz) = 20bcb36a7be3c25998dcb3fa445206a2

output:
MD5 (54_pca_var_norm_20_PC_nj.tre) = 09bc3ac3f1f1136dbfdc36d5c16c3703


Style tree in ggtree
```{r}

library(ape) #read.tree
library(ggtree)
library(ggplot2) 
library(phytools) #cophylo

setwd("~/repo/aqhumor/AqHum_5Species/")

#read in nj tree
tree <- ape::read.nexus("aqhumor_final/plots_final/figures/figure5_nj/54_pca_var_norm_20_PC_nj.tre")

labels.df <- data.frame(tip_num = c(1:length(tree$tip.label)),tip_label = tree$tip.label)

#wrangle tip names
#wrangle species tip names
tip_species <- sapply(strsplit(labels.df$tip_label, "_"),function(v){return(v[1])})

tip_species_wrangle <-gsub('human', "H. sap. ", tip_species) 
tip_species_wrangle <-gsub('mouse', "M. mus. ", tip_species_wrangle) 
tip_species_wrangle <-gsub('pig', "S. scr. ", tip_species_wrangle) 
tip_species_wrangle <-gsub('macM', "M. mul. ", tip_species_wrangle) 
tip_species_wrangle <-gsub('macF', "M. fas. ", tip_species_wrangle) 

#wrangle cell type tip names
#cell type tip names
tip_cell_type <- sapply(strsplit(labels.df$tip_label, "_"),function(v){return(v[4])})

tip_cell_type_wrangle <- gsub('Endo-Corneal', "Corneal Endothelium", tip_cell_type)
tip_cell_type_wrangle <- gsub('Endo-Vasc', "Vascular Endothelium", tip_cell_type_wrangle)
tip_cell_type_wrangle <- gsub('CollectorChn', "Collector Channel", tip_cell_type_wrangle)
tip_cell_type_wrangle <- gsub('SchlemmsCanal', "Schlemm Canal", tip_cell_type_wrangle)
tip_cell_type_wrangle <- gsub('Endo-Schlemms', "Schlemm Canal", tip_cell_type_wrangle)
tip_cell_type_wrangle <- gsub('SchwannCell-nmy', "Schwann Cell - nmy", tip_cell_type_wrangle)
tip_cell_type_wrangle <- gsub('SchwannCell-my', "Schwann Cell - my", tip_cell_type_wrangle)
#must put after Schwann Cell -nmy and -my or gsub does not work correctly
tip_cell_type_wrangle <- gsub('SchwannCell', "Schwann Cell", tip_cell_type_wrangle)
tip_cell_type_wrangle <- gsub('CiliaryMuscle', "Ciliary Muscle", tip_cell_type_wrangle)

#combine into new tip names
new_tree_labels <- paste0(tip_species_wrangle, " ", tip_cell_type_wrangle)
tree$tip.label <- new_tree_labels

#put together annotation df for ggtree
#italics + bold
lab_expression <- paste0("paste(italic('", tip_species_wrangle,"')", ", bold('",tip_cell_type_wrangle,"'))")
#make the expression the new tree tip labels. This will be passed to and parsed in geom_tiplab()
tree$tip.label <- lab_expression

gg_tree <- ggtree(tree, linewidth=1, color="black", ladderize=T, right=T) +
  geom_tiplab(parse=TRUE, size=6) +
  xlim(0,10)

#squish the clades
#find node numbers
ggtree(tree) + geom_text(aes(label=node))  + geom_tiplab()
#vertically compress clades of interest (horizontal branch lengths unchanged)
sc <- scaleClade(gg_tree, node=74, scale=0.50) %>% scaleClade(node=78, scale=0.50) %>% scaleClade(node=80, scale=0.50) %>% scaleClade(node=86, scale=0.50) %>% scaleClade(node=93, scale=0.50) %>% scaleClade(node=99, scale=0.50) %>% scaleClade(node=103, scale=0.50) %>% scaleClade(node=66, scale=0.50) %>% scaleClade(node=63, scale=0.50) %>% scaleClade(node=57, scale=0.50) %>% scaleClade(node=61, scale=0.50) 

#print tree
#pdf(file="lsi_54_jumble_search_tree_1249177875_focal_figure_scaled_19feb2023.pdf", width=17, height=15)
pdf(file="54_pca_var_norm_20_PC_nj_ggtree.pdf", width=17, height=15)
#print(tr) #unscaled version
print(sc)
dev.off()

```
input:
MD5 (54_pca_var_norm_20_PC_nj.tre) = 09bc3ac3f1f1136dbfdc36d5c16c3703
output:
MD5 (54_pca_var_norm_20_PC_nj_ggtree.pdf) = 5c73f7711d4d5cdb099c90d726f8d637

illustrator details
transform phylo pdf: w = 180 mm, h=158.824 mm
tip labels ~7

input
MD5 (54_pca_var_norm_20_PC_nj_ggtree.pdf) = 5c73f7711d4d5cdb099c90d726f8d637
output
MD5 (figure5_nj.ai) = 66afc7eaea947acc729a4c47514d9446
