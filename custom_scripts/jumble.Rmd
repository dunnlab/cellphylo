---
title: "Jumble trees"
output: html_notebook
---

The following scripts were used to estimate 'jumble trees' - replicate trees inferred from a single data set by jumbling the order of input taxa to contml.

...
### Jumble Run
54 cell
input: (same code as 92/57 jumble search with folder names changed)
MD5 (infile_54_20PC) = e98191bda1e3f82b7f45e8e8334f7768
MD5 (run_jumble_parallel_54.sh) = 914ce19f32281178e6ea237afd00a277
MD5 (script_jumble_parallel_54.sh) = 88c9b9f65f1219238c15772e60fd700b
output:
MD5 (output_54_jumble_search.tar.gz) = 04baf0ded1eb0f968fa6e0cf5641d686

### Remove missing/errored files
Fish out outfiles that are not empty (have 'Ln Likelihood')
```
find . -type f -print| xargs grep "Ln Likelihood"| cut -d ":" -f 1| xargs -I '{}' cp '{}' ../outfiles_57_jumble_search_2/
```
Delete any empty tree files
```
find ./ -size 0 -print -delete
```

<<<SCORE_SCJACK, BEST_TREE FUNCTIONS>>


Identify best jumble tree (by score) and calculate jumble score
```{r}

setwd("~/repo/aqhumor/AqHum_5species/")

tree_dir_path = "aqhumor_final/jumble/54_jumble_search/output_54_jumble_search_processed/outtrees_54_jumble_search_processed/"

#find best jumble tree
#best tree (sum of scores): index 101, outtree_57_jumble_search_2604209449.tre
best_scjack_tree(tree_dir_path = tree_dir_path)
list.files(tree_dir_path)

#label and score trees
#many ties for 54. label trees and choose the one with the best topology 
scjack_multiphylo <- combine_multi_trees(tree_dir_path)

matrix_path <- "aqhumor_final/jumble/54_jumble_search/contml_54cell_subset_pca_var_norm_20PC_mtx/"
mat <- Read10X(matrix_path)

tree_list <- c("outtree_54_jumble_search_1235256431.tre", "outtree_54_jumble_search_1249177875.tre", "outtree_54_jumble_search_1790537341.tre","outtree_54_jumble_search_2214045959.tre", "outtree_54_jumble_search_2481088323.tre","outtree_54_jumble_search_2642665967.tre","outtree_54_jumble_search_2892552345.tre","outtree_54_jumble_search_3280076499.tre",  "outtree_54_jumble_search_3567552921.tre", "outtree_54_jumble_search_542946467.tre", "outtree_54_jumble_search_545341417.tre","outtree_54_jumble_search_61674183.tre", "outtree_54_jumble_search_683352147.tre", "outtree_54_jumble_search_909119069.tre") %>% as.list()

labelled_trees <- lapply(tree_list, function(trees){
  focal_tree_path <- paste0("aqhumor_final/jumble/54_jumble_search/output_54_jumble_search_processed/outtrees_54_jumble_search_processed/", trees)
  
  #score tree
  tree <- score_scjack(scjack_multiphylo = scjack_multiphylo, focal_tree_path = focal_tree_path, print=TRUE)

  #label tree
  #connect cell ids to index 
  key.df <- data.frame(cell_id = rownames(mat), index = as.character(c(1:nrow(mat))))

  #load tree
  #tree <- read.tree(tree_path)
  #find tip label
  tips.df <- data.frame(index = tree$scored$tip.label)

  #connect tip id to cell id
  new_tip.df <- left_join(tips.df, key.df, by="index")

  #replace old tip indices with new tip cell id labels
  tree$scored$tip.label <- new_tip.df$cell_id
  
  file_name = trees
  write.tree(tree$scored, file=file_name)
  
  return(tree)
})

```


### Choose the 54 jumble search tree that is most representative
There are 14 best trees tied for best sum/mean of jumble scores. Choose the best tree that is most representative of the best trees

```{r}
library(phangorn)
library(proxy)

setwd ("~/repo/aqhumor/AqHum_5Species/")

#create a multiphylo of best trees
tree_dir_path <- "aqhumor_final/jumble/54_jumble_search/best_trees/best_trees_dir/"
multiphylo <- combine_multi_trees(tree_dir_path)

#make a distance matrix using R-F dist
RF_dist_mtx <- RF.dist(multiphylo) #all dists 0
path_dist_mtx <- path.dist(multiphylo) #all dists 0
KF_dist_mtx <- KF.dist(multiphylo) #dist varies

#which tree has the smallest sum of KF_dists?
KF_mat <- as.matrix(KF_dist_mtx)
colsums <- colSums(KF_mat)
min <- min(colsums) #0.2320657

```

This led us to identify tree 2 and 11
```{r}
#but KF dist between trees 2 and 11 = 1e-08. They are not identical
#index 2
tree_2 = read.tree("aqhumor_final/jumble/54_jumble_search/best_trees/best_trees_dir/outtree_54_jumble_search_1249177875.tre")
#index 11
tree_11 = read.tree("aqhumor_final/jumble/54_jumble_search/best_trees/best_trees_dir/outtree_54_jumble_search_545341417.tre")
KF.dist(tree1 = tree_2, tree2 = tree_11) #matches KF_dist_mtx

#tree 2 and 11 = 0.2320657, but this is rounded.
tree_2_colsum <- colsums[[2]]
tree_11_colsum <- colsums[[11]]
tree_2_colsum  < tree_11_colsum #TRUE 
tree_11_colsum < tree_2_colsum #FALSE

#remains true for colmeans
colmeans <- colMeans(KF_mat)
min(colmeans) #0.01657612 - trees index 2 and 11 with rounding, tree 2 < tree 11 without rounding
#average mean KF dist in KF_mat
mean(KF_mat) #0.02983213

#what is the most representative tree out of all the best trees by jumble score?
best_scjack_tree(tree_dir_path = tree_dir_path)

#list trees by index
list.files(tree_dir_path)

```
