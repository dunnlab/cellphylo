---
title: "Fig4_focal_phylogeny"
output: html_document
date: "2023-04-22"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Fig. 4 - focal phylogeny version 3 (with scjack TBE scores)
Run first chunk in original Fig. 4 code to produce:
```{r}
library(ape) #read.tree, write.tree
library(magrittr) #%>%

#use cell phylo
library(devtools)
setwd("~/repo/cellphylo/")
load_all()

#jumble tree
tree_dir_path = "../aqhumor/AqHum_5Species/aqhumor_final/jumble/54_jumble_search/output_54_jumble_search_processed/outtrees_54_jumble_search_processed/"

#score jumble tree
multiphylo <- combine_multi_trees(tree_dir_path)
focal_tree_path = "../aqhumor/AqHum_5Species/aqhumor_final/jumble/54_jumble_search/output_54_jumble_search_processed/outtrees_54_jumble_search_processed/outtree_54_jumble_search_1249177875.tre"
tree <- score_scjack(scjack_multiphylo = multiphylo, focal_tree_path = focal_tree_path, print=TRUE)

#extract tree with jumble scores
tree_jumble_sc <- tree$scored
#extract node labels and round
tree_jumble_nodelabels <- round(as.numeric(tree_jumble_sc$node.label))


#scjack tree
tree_scjack_tbe <- read.tree("../aqhumor/AqHum_5Species/aqhumor_final/scjackknife/scjack_54_jumble_search_TBE/run/outtree_54_jumble_search_1249177875_tbe_score.tre")


#extract scjack tbe scores, convert from decimal - multiply by 100
tree_scjack_nodelabels <-as.numeric(tree_scjack_tbe$node.label)*100
#round
tree_scjack_nodelabels <- round(tree_scjack_nodelabels)

#create new nodelabels for tree: jumble score/scjack tbe
combined_nodelabels <- paste0(tree_jumble_nodelabels, "/", tree_scjack_nodelabels)
#replace the NA at the root with empty space
combined_nodelabels[1] <- "100"
#add new nodelabels to jumble tree
tree_jumble_sc$node.label <- combined_nodelabels

#the scjack TBE did not calculate a score for the root. Replace NA with ""


#save_tree
write.tree(tree_jumble_sc, file="outtree_54_jumble_search_1249177875_tipnum_jumble_scjack_scored_figure.tre")

```
Run April 19 2023
input:
MD5 (output_54_jumble_search_processed.tar.gz) = 356dfe056f7947e3f9d396b4666767c1
MD5 (outtree_54_jumble_search_1249177875.tre) = 4ceeef9cfd5446f454f843e54a09277e
MD5 (outtree_54_jumble_search_1249177875_tbe_score.tre) = ac72f71a46ef35cf4df8cb06183d10bc

output:
MD5 (outtree_54_jumble_search_1249177875_tipnum_jumble_scjack_scored_figure.tre) = 971e7dbc9a487ae78d11f40106a725d2

```{r}
library(phangorn) #midpoint
library(Seurat) #Read10X
library(dplyr) #left_join

setwd("~/repo/cellphylo/")

#focal tree 
#tree must have number labels to match lsi results table, which has numbers for tip labels
#54 jumble search final best tree with jumble and scjack tbe scores
tree_path <- "../aqhumor/AqHum_5Species/aqhumor_final/plots_final/figures/figure4_focal_tree/outtree_54_jumble_search_1249177875_tipnum_jumble_scjack_scored_figure.tre"

#load tree
tree <- read.tree(tree_path)
#midpoint root tree
tree <- midpoint(tree)
#parse tips to make annotation df
tip.df <- data.frame(tip_num=tree$tip.label)

#map tree tips to labels
mat <- Read10X("../aqhumor/AqHum_5Species/aqhumor_final/jumble/54_jumble_search/contml_54cell_subset_pca_var_norm_20PC_mtx/")

cell_labels <- rownames(mat)
labels.df <- data.frame(tip_num = as.character(1:length(cell_labels)), tip_label = cell_labels)
labels.df <- left_join(tip.df, labels.df, by="tip_num")

#load lsi results table
lsi_table.df <- read.table("../aqhumor/AqHum_5Species/aqhumor_final/jumble/54_jumble_search/lsi/lsi_54_jumble_search_results_table.txt", header=FALSE) %>% as.data.frame()
colnames(lsi_table.df) <- c("tip_num", "lsi")
lsi_table.df$tip_num <- as.character(lsi_table.df$tip_num)
ann.df <- left_join(labels.df, lsi_table.df, by="tip_num" )

#Wrangle tip names
#species tip names
tip_species <- sapply(strsplit(ann.df$tip_label, "_"),function(v){return(v[1])})

tip_species_wrangle <-gsub('human', "H. sap. ", tip_species) 
tip_species_wrangle <-gsub('mouse', "M. mus. ", tip_species_wrangle) 
tip_species_wrangle <-gsub('pig', "S. scr. ", tip_species_wrangle) 
tip_species_wrangle <-gsub('macM', "M. mul. ", tip_species_wrangle) 
tip_species_wrangle <-gsub('macF', "M. fas. ", tip_species_wrangle) 


#cell type tip names
tip_cell_type <- sapply(strsplit(ann.df$tip_label, "_"),function(v){return(v[4])})

tip_cell_type_wrangle <- gsub('Endo-Corneal', "Corneal Endothelium", tip_cell_type)
tip_cell_type_wrangle <- gsub('Endo-Vasc', "Vascular Endothelium", tip_cell_type_wrangle)
tip_cell_type_wrangle <- gsub('CollectorChn', "Collector Channel", tip_cell_type_wrangle)
tip_cell_type_wrangle <- gsub('SchlemmsCanal', "Schlemm Canal", tip_cell_type_wrangle)
tip_cell_type_wrangle <- gsub('Endo-Schlemms', "Schlemm Canal", tip_cell_type_wrangle)
tip_cell_type_wrangle <- gsub('SchwannCell-nmy', "Schwann Cell - nmy", tip_cell_type_wrangle)
tip_cell_type_wrangle <- gsub('SchwannCell-my', "Schwann Cell - my", tip_cell_type_wrangle)
#must put after Schwann Cell -nmy and -my or gsub does not work correctly
tip_cell_type_wrangle <- gsub('SchwannCell', "Schwann Cell", tip_cell_type_wrangle)
tip_cell_type_wrangle <- gsub('CiliaryMuscle', "Ciliary Muscle", tip_cell_type_wrangle)

#combine into new tip names
new_tree_labels <- paste0(tip_species_wrangle, " ", tip_cell_type_wrangle)
tree$tip.label <- new_tree_labels

ann.df <- ann.df %>% mutate(tip = new_tree_labels, species_wrangle = tip_species_wrangle, cell_type_wrangle = tip_cell_type_wrangle)
ann_lsi.df <- ann.df %>% select(tip, lsi)

```

input:
contml_54cell_subset_pca_var_norm_20PC_mtx/matrix.mtx.gz = 20bcb36a7be3c25998dcb3fa445206a2
lsi_54_jumble_search_results_table.txt = 5fcf4922e29717f439f335ae36d6ddb5

ggtree
```{r}
library(ggtree)
library(ggplot2) #scale_color_viridis_c

#colour tips by lsi

#italics + bold
lab_expression <- paste0("paste(italic('", tip_species_wrangle,"')", ", bold('",tip_cell_type_wrangle,"'))")
#make the expression the new tree tip labels. This will be passed to and parsed in geom_tiplab()
tree$tip.label <- lab_expression
#tip labels and tip col in annotations df must match for ggtree to link lsi values to tip color
ann_lsi.df$tip <- lab_expression

#ggtree
lsi_tree <- ggtree(tree,aes(colour=lsi), linewidth=1, color="black", ladderize=T, right=T) %<+% ann_lsi.df +
  geom_tiplab(parse=TRUE, size=5) +
  geom_text2(aes(label=label, subset=(!isTip)), hjust=1.15, vjust=-0.50) +
  scale_color_viridis_c(na.value="black") + 
  labs(colour="LSI") +
  xlim(0,5) 

#plot tree
lsi_tree

#vertically compress clades of interest (horizontal branch lengths unchanged)
sc <- scaleClade(lsi_tree, node=93, scale=0.50) %>% scaleClade(node=80, scale=0.50) %>% scaleClade(node=76, scale=0.50) %>% scaleClade(node=72, scale=0.50) %>% scaleClade(node=107, scale=0.50) %>% scaleClade(node=56, scale=0.50) %>% scaleClade(node=98, scale=0.50) %>% scaleClade(node=89, scale=0.50) %>% scaleClade(node=87, scale=0.50) %>% scaleClade(node=64, scale=0.50) %>% scaleClade(node=60, scale=0.50) 


#print tree
#scaled, ladderize=T, right=T, no manual clade rotation:
pdf(file="lsi_54_jumble_search_tree_1249177875_focal_20apr2023.pdf", width=17, height=15)
print(sc)
dev.off()

```
input:
see code chunkone  above

output:
MD5 (lsi_54_jumble_search_tree_1249177875_focal_20apr2023.pdf) = 49179f915db6748a07d554fd2f892732


edit some support values that are obscured by hand in the pdf
input:
MD5 (lsi_54_jumble_search_tree_1249177875_focal_20apr2023.pdf) = 49179f915db6748a07d554fd2f892732
output:
MD5 (lsi_54_jumble_search_tree_1249177875_focal_20apr2023_edit.pdf) = 00550d137ac67ca8da24e6f3ceea8a82


illustrator details:
180 mm x 210 mm illustrator artboard
transform: w = 215.9 mm, h = 190.5 mm (will overlap artboard)
support values - ~6 pt
tip labels  = 7 pt

legend: w = 11.761 mm, h = 24.172 mm
legend title ~7 pt, numbers ~6 pt

input
MD5 (legend_20apr2023.png) = daef8baeabbfeee482888b659d39d3bd
MD5 (lsi_54_jumble_search_tree_1249177875_focal_20apr2023_edit.pdf) = 00550d137ac67ca8da24e6f3ceea8a82

output:
MD5 (fig4_focal_v4_20apr2023.ai) = ed80bbc49dfaa7c874feaba2e71dfcab

